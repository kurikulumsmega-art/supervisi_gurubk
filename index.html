<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supervisi Guru BK - SMKN 1 Purbalingga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-btn.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                background-color: #fff;
            }
            .container {
                padding: 0;
            }
            div[class*="shadow-md"] {
                box-shadow: none;
                border: 1px solid #e5e7eb;
            }
            #signature-section {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8">
        <header class="text-center mb-8 bg-white p-6 rounded-xl shadow-md no-print">
            <h1 class="text-2xl md:text-3xl font-bold text-blue-600">Supervisi Guru BK</h1>
            <p class="text-lg md:text-xl font-semibold text-gray-700">SMK Negeri 1 Purbalingga</p>
        </header>

        <!-- Tab Buttons -->
        <div class="mb-6 flex justify-center border-b border-gray-300 no-print">
            <button id="tab-klasikal-btn" class="tab-btn active text-lg py-3 px-6 border-b-2 border-transparent transition-colors duration-300" onclick="switchTab('klasikal')">Bimbingan Klasikal</button>
            <button id="tab-administrasi-btn" class="tab-btn text-lg py-3 px-6 border-b-2 border-transparent transition-colors duration-300" onclick="switchTab('administrasi')">Administrasi BK</button>
        </div>

        <main id="app-content">
            <!-- Informasi Umum -->
            <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                <h2 class="text-xl font-bold mb-4 border-b pb-2 text-gray-700">Informasi Umum</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="nama_guru" class="block text-sm font-medium text-gray-600">Nama Guru</label>
                        <input type="text" id="nama_guru" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="nip" class="block text-sm font-medium text-gray-600">NIP</label>
                        <input type="text" id="nip" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div id="info-klasikal">
                        <div>
                            <label for="kelas_semester" class="block text-sm font-medium text-gray-600">Kelas/Semester</label>
                            <input type="text" id="kelas_semester" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="tanggal" class="block text-sm font-medium text-gray-600">Hari, Tanggal (Jam ke)</label>
                            <input type="text" id="tanggal" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div id="info-administrasi" class="hidden">
                         <div>
                            <label for="tahun_pelajaran" class="block text-sm font-medium text-gray-600">Tahun Pelajaran</label>
                            <input type="text" id="tahun_pelajaran" value="2024/2025" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="semester" class="block text-sm font-medium text-gray-600">Semester</label>
                            <input type="text" id="semester" value="Ganjil" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Konten Tab -->
            <div id="tab-klasikal-content">
                <form id="form-klasikal" class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold mb-4 text-gray-700">Instrumen Supervisi Bimbingan Klasikal</h2>
                    <div id="instrumen-klasikal-container" class="space-y-4"></div>
                </form>
            </div>

            <div id="tab-administrasi-content" class="hidden">
                <form id="form-administrasi" class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold mb-4 text-gray-700">Supervisi Administrasi Guru BK</h2>
                    <div id="instrumen-administrasi-container" class="space-y-4"></div>
                </form>
            </div>
            
            <!-- Hasil & Aksi -->
            <div class="bg-white p-6 rounded-xl shadow-md mt-6">
                <div id="summary-section">
                    <!-- Summary inputs for Klasikal -->
                    <div id="summary-klasikal" class="space-y-4">
                        <div>
                            <label for="kesimpulan_klasikal" class="block text-sm font-medium text-gray-600">Kesimpulan</label>
                            <textarea id="kesimpulan_klasikal" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                        <div>
                            <label for="refleksi_klasikal" class="block text-sm font-medium text-gray-600">Refleksi</label>
                            <textarea id="refleksi_klasikal" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                        <div>
                            <label for="rekomendasi_klasikal" class="block text-sm font-medium text-gray-600">Rekomendasi</label>
                            <textarea id="rekomendasi_klasikal" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                    </div>
                     <!-- Summary inputs for Administrasi -->
                    <div id="summary-administrasi" class="hidden space-y-4">
                        <div>
                            <label for="komentar_admin" class="block text-sm font-medium text-gray-600">Komentar / Saran</label>
                            <textarea id="komentar_admin" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row items-center justify-between mt-6 pt-6 border-t no-print">
                     <div class="flex flex-wrap gap-2 justify-center w-full">
                        <button onclick="calculateScores()" class="flex-grow sm:flex-grow-0 bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-300 shadow-md">Hitung Skor & Simpan</button>
                        <button onclick="exportToCSV()" class="flex-grow sm:flex-grow-0 bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition duration-300 shadow-md">Export ke CSV</button>
                        <button onclick="window.print()" class="flex-grow sm:flex-grow-0 bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700 transition duration-300 shadow-md">Cetak Laporan</button>
                    </div>
                </div>

                <div id="hasil-penilaian" class="mt-6 hidden">
                    <h3 class="text-lg font-bold text-gray-800">Hasil Penilaian</h3>
                    <div class="mt-2 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <p class="text-lg">Skor Total: <span id="skor_total" class="font-bold">0</span></p>
                        <p class="text-lg">Skor Maksimal: <span id="skor_maksimal" class="font-bold">0</span></p>
                        <p class="text-lg">Nilai Akhir: <span id="nilai_akhir" class="font-bold">0%</span></p>
                        <p class="text-xl mt-2">Peringkat: <span id="keterangan_nilai" class="font-bold text-blue-700">-</span></p>
                    </div>
                </div>

                <!-- Tanda Tangan Section -->
                <div id="signature-section" class="mt-10 pt-6 border-t border-gray-200 hidden">
                    <div class="flex justify-between items-start text-center text-sm sm:text-base">
                        <div class="w-1/2 px-2">
                            <p>Mengetahui,</p>
                            <p>Kepala Sekolah selaku Supervisor</p>
                            <div class="h-16"></div>
                            <p class="font-bold underline">Maryono, S.Pd., M.Si</p>
                            <p>NIP. 19660701 200012 1002</p>
                        </div>
                        <div class="w-1/2 px-2">
                            <p id="signature-date-location">Purbalingga, [Tanggal]</p>
                            <p>Guru BK</p>
                            <div class="h-16"></div>
                            <p class="font-bold underline" id="guru-bk-nama-ttd">[Nama Guru BK]</p>
                            <p>NIP. <span id="guru-bk-nip-ttd">[NIP Guru BK]</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </main>

    </div>

    <script>
        // Data instrumen Bimbingan Klasikal
        const instrumenKlasikal = [
            { kategori: 'A. PERSIAPAN PELAKSANAAN BIMBINGAN KLASIKAL', aspek: 'Melaksanakan asesmen kebutuhan materi bimbingan klasikal', id: 'klasikal_1' },
            { kategori: 'A. PERSIAPAN PELAKSANAAN BIMBINGAN KLASIKAL', aspek: 'Terjadwal masuk kelas secara rutin', id: 'klasikal_2' },
            { kategori: 'A. PERSIAPAN PELAKSANAAN BIMBINGAN KLASIKAL', aspek: 'Memiliki data siswa yang menjadi ampuannya', id: 'klasikal_3' },
            { kategori: 'RENCANA PELAKSANAAN LAYANAN (RPL)', aspek: 'Menyusun RPL bimbingan klasikal/kelompok untuk masing-masing bidang (pribadi, belajar, sosial dan karier) dan memuat fungsi layanan', id: 'klasikal_4' },
            { kategori: 'RENCANA PELAKSANAAN LAYANAN (RPL)', aspek: 'Topik dan tujuan layanan dirumuskan dengan kalimat operasional', id: 'klasikal_5' },
            { kategori: 'RENCANA PELAKSANAAN LAYANAN (RPL)', aspek: 'Memuat dengan jelas sasaran dan waktu pelaksanaan layanan', id: 'klasikal_6' },
            { kategori: 'RENCANA PELAKSANAAN LAYANAN (RPL)', aspek: 'Merumuskan metode dan teknik yang akan digunakan untuk menyajikan materi bimbingan klasikal', id: 'klasikal_7' },
            { kategori: 'RENCANA PELAKSANAAN LAYANAN (RPL)', aspek: 'Memilih media sesuai dengan karakteristik sasaran layanan', id: 'klasikal_8' },
            { kategori: 'RENCANA PELAKSANAAN LAYANAN (RPL)', aspek: 'Menguraikan tahapan kegiatan dalam penyelenggaraan kegiatan, setidaknya memuat tahapan awal, tahap inti dan terminasi/penutupan', id: 'klasikal_9' },
            { kategori: 'RENCANA PELAKSANAAN LAYANAN (RPL)', aspek: 'Memuat jenis evaluasi yang akan dilaksanakan, baik evaluasi proses maupun evaluasi hasil.', id: 'klasikal_10' },
            { kategori: 'B. PELAKSANAAN - Tahapan awal', aspek: 'Keterampilan dalam membentuk hubungan dan memotivasi (contoh: memeriksa kesiapan, mengapresiasi kehadiran dan memberi perhatian bagi siswa yang tidak hadir)', id: 'klasikal_11' },
            { kategori: 'B. PELAKSANAAN - Tahapan awal', aspek: 'Menyampaikan tujuan yang akan dicapai dan langkah-langkah kegiatan', id: 'klasikal_12' },
            { kategori: 'B. PELAKSANAAN - Tahapan awal', aspek: 'Memberikan pengantar materi', id: 'klasikal_13' },
            { kategori: 'Tahap Inti/Kerja', aspek: 'Kemampuan dalam menerapkan metode dan teknik dalam menyajikan topik bimbingan', id: 'klasikal_14' },
            { kategori: 'Tahap Inti/Kerja', aspek: 'Keterampilan dalam menggunakan media', id: 'klasikal_15' },
            { kategori: 'Tahap Inti/Kerja', aspek: 'Metode dan media yang digunakan menumbuhkan minat dan keaktifan siswa', id: 'klasikal_16' },
            { kategori: 'Tahap Inti/Kerja', aspek: 'Kemampuan dalam mengelola kelas termasuk memberikan perhatian bagi siswa yang kesulitan', id: 'klasikal_17' },
            { kategori: 'Tahap Inti/Kerja', aspek: 'Memberikan kesempatan untuk bertanya', id: 'klasikal_18' },
            { kategori: 'Tahap Inti/Kerja', aspek: 'Memberikan respon dan tanggapan secara tepat', id: 'klasikal_19' },
            { kategori: 'Tahap Inti/Kerja', aspek: 'Mengelola waktu dengan baik', id: 'klasikal_20' },
            { kategori: 'Tahap Inti/Kerja', aspek: 'Melakukan pengamatan keaktifan siswa sebagai dasar melakukan evaluasi proses layanan', id: 'klasikal_21' },
            { kategori: 'Tahap Akhir/Terminasi', aspek: 'Kemampuan untuk mengajak siswa merefleksikan pengalaman (bisa menjadi dasar evaluasi hasil)', id: 'klasikal_22' },
            { kategori: 'Tahap Akhir/Terminasi', aspek: 'Menyimpulkan hasil pertemuan secara efektif dan menutup pertemuan dengan simpatik (framming)', id: 'klasikal_23' },
        ];
        
        // Data instrumen Administrasi BK (TEMPLATE BARU)
        const instrumenAdministrasi = [
            { kategori: 'Dokumen Wajib', komponen: 'Memiliki Angket Kebutuhan Peserta Didik', id: 'admin_new_1' },
            { kategori: 'Dokumen Wajib', komponen: 'Memiliki Data Analisis Kebutuhan Siswa', id: 'admin_new_2' },
            { kategori: 'Dokumen Wajib', komponen: 'Memiliki Program Layanan BK', id: 'admin_new_3' },
            { kategori: 'Dokumen Wajib', komponen: 'Kalender Pendidikan dan analisis minggu efektif', id: 'admin_new_4' },
            { kategori: 'Dokumen Wajib', komponen: 'Memiliki Jadwal Layanan BK', id: 'admin_new_5' },
            { kategori: 'Dokumen Wajib', komponen: 'Memiliki Standar Kompetensi Kemandirian Peserta Didik.', id: 'admin_new_6' },
            { kategori: 'Dokumen Wajib', komponen: 'Memiliki Rencana Persiapan Layanan (RPL)', id: 'admin_new_7' },
            { kategori: 'Dokumen Wajib', komponen: 'Memiliki Kumpulan Materi Layanan BK', id: 'admin_new_8' },
            { kategori: 'Dokumen Wajib', komponen: 'Memiliki Buku Kolaborasi', id: 'admin_new_9' },
            { kategori: 'Dokumen Wajib', komponen: 'Memiliki Agenda Guru / Jurnal Layanan Bimbingan', id: 'admin_new_10' },
            { kategori: 'Dokumen Wajib', komponen: 'Memiliki Buku Catatan Konseling', id: 'admin_new_11' },
            { kategori: 'Dokumen Wajib', komponen: 'Memiliki Dokumen Home Visit', id: 'admin_new_12' },
            { kategori: 'Dokumen Wajib', komponen: 'Memiliki Dokumen Evaluasi Layanan BK', id: 'admin_new_13' },
            { kategori: 'Dokumen Wajib', komponen: 'Memiliki dokumen tindak lanjut layanan BK', id: 'admin_new_14' },
            { kategori: 'Dokumen Penunjang', komponen: 'Memiliki daftar hadir peserta didik', id: 'admin_new_15' },
            { kategori: 'Dokumen Penunjang', komponen: 'Melakukan Pengembangan Keprofesian Berkelanjutan', id: 'admin_new_16' }
        ];

        let currentTab = 'klasikal';

        // Fungsi untuk render form
        function renderForms() {
            // Render form Klasikal
            const containerKlasikal = document.getElementById('instrumen-klasikal-container');
            containerKlasikal.innerHTML = ''; // Clear previous content
            let currentKategoriKlasikal = '';
            instrumenKlasikal.forEach((item, index) => {
                if (item.kategori !== currentKategoriKlasikal) {
                    currentKategoriKlasikal = item.kategori;
                    const kategoriHeader = document.createElement('h3');
                    kategoriHeader.className = 'text-lg font-semibold mt-6 pt-4 border-t text-blue-600';
                    kategoriHeader.textContent = currentKategoriKlasikal;
                    containerKlasikal.appendChild(kategoriHeader);
                }
                containerKlasikal.appendChild(createKlasikalItem(item, index + 1));
            });
            
            // Render form Administrasi
            const containerAdministrasi = document.getElementById('instrumen-administrasi-container');
            containerAdministrasi.innerHTML = ''; // Clear previous content
            let currentKategoriAdmin = '';
            instrumenAdministrasi.forEach((item, index) => {
                 if (item.kategori !== currentKategoriAdmin) {
                    currentKategoriAdmin = item.kategori;
                    const kategoriHeader = document.createElement('h3');
                    kategoriHeader.className = 'text-lg font-semibold mt-6 pt-4 border-t text-blue-600';
                    kategoriHeader.textContent = currentKategoriAdmin;
                    containerAdministrasi.appendChild(kategoriHeader);
                }
                containerAdministrasi.appendChild(createAdministrasiItem(item, index + 1));
            });
        }

        function createKlasikalItem(item, number) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'p-4 border rounded-lg hover:bg-gray-50';
            
            const content = `
                <p class="font-medium">${number}. ${item.aspek}</p>
                <div class="flex items-center space-x-6 mt-2">
                    <div class="flex items-center">
                        <input type="radio" id="${item.id}_0" name="${item.id}" value="0" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                        <label for="${item.id}_0" class="ml-2 block text-sm text-gray-900">0 (Tidak Sesuai)</label>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="${item.id}_1" name="${item.id}" value="1" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                        <label for="${item.id}_1" class="ml-2 block text-sm text-gray-900">1 (Sesuai Sebagian)</label>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="${item.id}_2" name="${item.id}" value="2" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" checked>
                        <label for="${item.id}_2" class="ml-2 block text-sm text-gray-900">2 (Sesuai Semua)</label>
                    </div>
                </div>
                <textarea id="catatan_${item.id}" placeholder="Catatan..." class="mt-2 w-full px-3 py-2 text-sm bg-white border border-gray-200 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
            `;
            itemDiv.innerHTML = content;
            return itemDiv;
        }

        function createAdministrasiItem(item, number) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'p-4 border rounded-lg hover:bg-gray-50';
            
            const content = `
                <p class="font-medium">${number}. ${item.komponen}</p>
                <div class="flex flex-wrap items-center gap-x-4 gap-y-2 mt-2">
                    <div class="flex items-center">
                        <input type="radio" id="${item.id}_0" name="${item.id}" value="0" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                        <label for="${item.id}_0" class="ml-2 block text-sm text-gray-900">0</label>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="${item.id}_1" name="${item.id}" value="1" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                        <label for="${item.id}_1" class="ml-2 block text-sm text-gray-900">1</label>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="${item.id}_2" name="${item.id}" value="2" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                        <label for="${item.id}_2" class="ml-2 block text-sm text-gray-900">2</label>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="${item.id}_3" name="${item.id}" value="3" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                        <label for="${item.id}_3" class="ml-2 block text-sm text-gray-900">3</label>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="${item.id}_4" name="${item.id}" value="4" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" checked>
                        <label for="${item.id}_4" class="ml-2 block text-sm text-gray-900">4</label>
                    </div>
                </div>
                 <textarea id="keterangan_${item.id}" placeholder="Keterangan..." class="mt-2 w-full px-3 py-2 text-sm bg-white border border-gray-200 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
            `;
            itemDiv.innerHTML = content;
            return itemDiv;
        }

        // Fungsi ganti tab
        function switchTab(tabName) {
            currentTab = tabName;
            document.getElementById('tab-klasikal-content').classList.toggle('hidden', tabName !== 'klasikal');
            document.getElementById('tab-administrasi-content').classList.toggle('hidden', tabName !== 'administrasi');
            
            document.getElementById('info-klasikal').classList.toggle('hidden', tabName !== 'klasikal');
            document.getElementById('info-administrasi').classList.toggle('hidden', tabName !== 'administrasi');

            document.getElementById('summary-klasikal').classList.toggle('hidden', tabName !== 'klasikal');
            document.getElementById('summary-administrasi').classList.toggle('hidden', tabName !== 'administrasi');
            
            document.getElementById('tab-klasikal-btn').classList.toggle('active', tabName === 'klasikal');
            document.getElementById('tab-administrasi-btn').classList.toggle('active', tabName === 'administrasi');
            document.getElementById('hasil-penilaian').classList.add('hidden');
            document.getElementById('signature-section').classList.add('hidden');
        }

        function calculateScores() {
            let totalScore = 0;
            let maxScore = 0;
            let finalPercentage = 0;
            let grade = '-';

            if (currentTab === 'klasikal') {
                instrumenKlasikal.forEach(item => {
                    const score = document.querySelector(`input[name="${item.id}"]:checked`);
                    if (score) {
                        totalScore += parseInt(score.value);
                    }
                });
                maxScore = instrumenKlasikal.length * 2;
                finalPercentage = maxScore > 0 ? ((totalScore / maxScore) * 100).toFixed(2) : 0;
                
                if (finalPercentage >= 91) grade = 'Sangat Baik';
                else if (finalPercentage >= 76) grade = 'Baik';
                else if (finalPercentage >= 61) grade = 'Cukup';
                else grade = 'Kurang';
                // Update label for result
                document.querySelector('#hasil-penilaian p:last-child').innerHTML = `Keterangan: <span id="keterangan_nilai" class="font-bold text-blue-700">-</span>`;

            } else { // administrasi (template baru)
                 instrumenAdministrasi.forEach(item => {
                    const score = document.querySelector(`input[name="${item.id}"]:checked`);
                    if (score) {
                        totalScore += parseInt(score.value);
                    }
                });
                maxScore = instrumenAdministrasi.length * 4;
                finalPercentage = maxScore > 0 ? ((totalScore / maxScore) * 100).toFixed(0) : 0;
                
                if (finalPercentage > 90) grade = 'Amat Baik (AB)';
                else if (finalPercentage > 80) grade = 'Baik (B)';
                else if (finalPercentage > 70) grade = 'Cukup (C)';
                else grade = 'Kurang (K)';
                // Update label for result
                document.querySelector('#hasil-penilaian p:last-child').innerHTML = `Peringkat: <span id="keterangan_nilai" class="font-bold text-blue-700">-</span>`;
            }

            document.getElementById('skor_total').textContent = totalScore;
            document.getElementById('skor_maksimal').textContent = maxScore;
            document.getElementById('nilai_akhir').textContent = `${finalPercentage}%`;
            document.getElementById('keterangan_nilai').textContent = grade;
            document.getElementById('hasil-penilaian').classList.remove('hidden');

            // Update and show signature section
            const namaGuru = document.getElementById('nama_guru').value || '[Nama Guru Belum Diisi]';
            const nipGuru = document.getElementById('nip').value || '[NIP Belum Diisi]';
            
            const today = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = today.toLocaleDateString('id-ID', options);

            document.getElementById('guru-bk-nama-ttd').textContent = namaGuru;
            document.getElementById('guru-bk-nip-ttd').textContent = nipGuru;
            document.getElementById('signature-date-location').textContent = `Purbalingga, ${formattedDate}`;

            document.getElementById('signature-section').classList.remove('hidden');
        }

        function exportToCSV() {
            calculateScores(); // Ensure scores are calculated before export
            
            let csvContent = "data:text/csv;charset=utf-8,";
            const namaGuru = document.getElementById('nama_guru').value.replace(/,/g, '') || 'Belum Diisi';
            const nip = document.getElementById('nip').value || '-';

            csvContent += `SUPERVISI GURU BK - SMKN 1 PURBALINGGA\n`;
            csvContent += `Nama Guru,${namaGuru}\n`;
            csvContent += `NIP,${nip}\n\n`;

            if (currentTab === 'klasikal') {
                const kelas = document.getElementById('kelas_semester').value || '-';
                const tanggal = document.getElementById('tanggal').value || '-';
                csvContent += `Tipe Supervisi,Bimbingan Klasikal\n`;
                csvContent += `Kelas/Semester,${kelas}\n`;
                csvContent += `Hari Tanggal,${tanggal}\n\n`;
                csvContent += "No,Kategori,Aspek Penilaian,Skor (0-2),Catatan\n";
                
                instrumenKlasikal.forEach((item, index) => {
                    const score = document.querySelector(`input[name="${item.id}"]:checked`)?.value || 'N/A';
                    const catatan = document.getElementById(`catatan_${item.id}`).value.replace(/,/g, ';').replace(/\n/g, ' ');
                    csvContent += `${index + 1},"${item.kategori}","${item.aspek}",${score},"${catatan}"\n`;
                });
                
                csvContent += "\nRINGKASAN\n";
                csvContent += `Kesimpulan,"${document.getElementById('kesimpulan_klasikal').value.replace(/,/g, ';').replace(/\n/g, ' ')}"\n`;
                csvContent += `Refleksi,"${document.getElementById('refleksi_klasikal').value.replace(/,/g, ';').replace(/\n/g, ' ')}"\n`;
                csvContent += `Rekomendasi,"${document.getElementById('rekomendasi_klasikal').value.replace(/,/g, ';').replace(/\n/g, ' ')}"\n`;

            } else { // administrasi
                const tahun = document.getElementById('tahun_pelajaran').value || '-';
                const semester = document.getElementById('semester').value || '-';
                csvContent += `Tipe Supervisi,Administrasi BK\n`;
                csvContent += `Tahun Pelajaran,${tahun}\n`;
                csvContent += `Semester,${semester}\n\n`;
                csvContent += "No,Kategori,Komponen Administrasi,Skor (0-4),Keterangan\n";
                
                instrumenAdministrasi.forEach((item, index) => {
                    const score = document.querySelector(`input[name="${item.id}"]:checked`)?.value || 'N/A';
                    const keterangan = document.getElementById(`keterangan_${item.id}`).value.replace(/,/g, ';').replace(/\n/g, ' ');
                    csvContent += `${index + 1},"${item.kategori}","${item.komponen}",${score},"${keterangan}"\n`;
                });

                csvContent += "\nRINGKASAN\n";
                csvContent += `Komentar / Saran,"${document.getElementById('komentar_admin').value.replace(/,/g, ';').replace(/\n/g, ' ')}"\n`;
            }

            // Hasil Akhir
            const skorTotal = document.getElementById('skor_total').textContent;
            const skorMaksimal = document.getElementById('skor_maksimal').textContent;
            const nilaiAkhir = document.getElementById('nilai_akhir').textContent;
            const keteranganNilai = document.getElementById('keterangan_nilai').textContent;

            csvContent += `\nHASIL AKHIR\n`;
            csvContent += `Skor Total,${skorTotal}\n`;
            csvContent += `Skor Maksimal,${skorMaksimal}\n`;
            csvContent += `Nilai Akhir,${nilaiAkhir}\n`;
            csvContent += `Peringkat,${keteranganNilai}\n`;

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `supervisi_bk_${namaGuru.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Render form saat halaman dimuat
        window.onload = renderForms;
    </script>
</body>
</html>

